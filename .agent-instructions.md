# CLAUDE.md — Projektkonstitution

Detta dokument styr all utveckling av denna app. Läs det innan du skriver kod.
Om en instruktion i detta dokument motsäger en annan fil i `docs/`, gäller detta dokument.

---

## Vad appen är

En adaptiv matematikträningsapp för svenska grundskoleelever (åk 4–9).
Appen körs på elevernas surfplattor. Lärare använder främst laptop.

Appen har två delar som bildar en helhet:

### Del 1 — Elevens träning

Eleven öppnar appen, loggar in, och börjar räkna. Inget krångel, ingen
provkänsla. Appen håller dem i en zon kring 85% rätt — tillräckligt många
lyckade svar för att känna sig kapabel, tillräckligt med utmaningar för att
faktiskt lära sig. Eleven kan antingen låta appen välja vad de övar (blandat)
eller välja ett specifikt område själv.

Från elevens perspektiv: logga in, räkna, få direkt feedback, fortsätt.

### Del 2 — Lärarens fönster in i elevernas tänkande

Medan eleverna tränar genererar varje svar data — inte bara rätt/fel, utan
*vilken sorts fel*. Läraren öppnar dashboarden under lektionen och ser:

- Alfred är på nivå 6 i addition men nivå 3 i bråk.
- Alfred tror konsekvent att större nämnare = större bråk (1/5 > 1/3 "för att 5 > 3").
- Tre andra elever visar samma mönster.

Det är en signal. Läraren kan samla de fyra eleverna och jobba med just den
missuppfattningen. Utan appen hade det tagit veckor att upptäcka mönstret.

### Hur delarna hänger ihop

Missuppfattningsdetekteringen är inte ett separat diagnostiskt test.
Den sker *under* den vanliga träningen. Varje felaktigt svar analyseras
automatiskt av domänens felanalys. Eleven märker ingenting — de bara
tränar. Läraren ser allt — mönster, nivåer, trender.

Det är därför appen har ett domäninterface med `analyzeError` som körs
på varje fel. Det finns inte för teknisk elegans. Det finns för att läraren
ska kunna se att "det här barnet förstår inte positionssystemet" istället
för bara "det här barnet har 43% rätt på multiplikation."

## Tre nivåer av felbedömning

Appen skiljer på:

1. **Ouppmärksamhetsfel** — eleven kan men slarvade (adderade istället
   för subtraherade, glömde en nolla). Ska inte sänka elevens nivå kraftigt
   och ska inte flaggas som kunskapsbrist för läraren.

2. **Kunskapsfel** — eleven har inte lärt sig metoden ännu. Normalt i
   progression. Adaptiva motorn justerar svårighetsgraden.

3. **Missuppfattningar** — eleven har en systematisk felaktig modell.
   Det farligaste fallet, för det ser ibland ut som kunskap (eleven svarar
   snabbt och säkert — men fel). Kräver riktad pedagogisk insats, inte
   bara mer träning på samma sak.

Nivå 3 är appens viktigaste bidrag. Utan den är appen bara en räknare
med adaptiv svårighet. Med den är appen ett diagnostiskt verktyg.

---

## Arkitektur

### Domänmodell

Appen är organiserad i **domäner**. Varje domän representerar ett matematiskt
område: aritmetik, bråk, decimaltal, procent, osv.

Varje domän är en fristående modul i `src/domains/`. Att lägga till en ny domän
innebär att skapa en ny mapp — inte att redigera befintliga filer.

```
src/domains/
├── registry.js              # Registrerar alla domäner
├── arithmetic/              # Finns idag
│   ├── index.js
│   ├── generate.js
│   ├── evaluate.js
│   ├── analyzeError.js
│   ├── Display.jsx
│   └── templates/
└── fractions/               # Framtida exempel
    ├── index.js
    ├── ...
```

### Domäninterfacet

Varje domän exporterar ett objekt med exakt denna form:

```js
export default {
  id: 'arithmetic',
  label: 'Aritmetik',

  skills: [
    { id: 'addition', label: 'Addition', levels: [1, 12] },
    // ...
  ],

  generate(skill, level, options) → Problem,
  Display: ReactComponent,
  evaluate(problem, studentAnswer) → EvalResult,
  analyzeError(problem, studentAnswer) → ErrorAnalysis,
}
```

**`generate`** skapar ett problem. Anropas av adaptiva motorn.
Returnerar ett Problem-objekt (se nedan).

**`Display`** är en React-komponent som renderar uppgiften och tar emot svar.
Domänen äger sin UI helt. Aritmetik visar `a + b = ?` med sifferknappar.
Bråk kan visa bråkstreck, tallinjer, eller ordningsuppgifter.

**`evaluate`** avgör om svaret är korrekt. Mekanisk bedömning.
Används av adaptiva motorn för svårighetsjustering.

**`analyzeError`** avgör *varför* svaret är fel. Pedagogisk bedömning.
Används av lärardashboarden för insikter.
Dessa två är separata för att de tjänar olika syften.

### Problem-objektet

Alla problem, oavsett domän, har samma yttre form:

```js
{
  id: 'add_1d_2d_carry_1738000000_x3k',
  domain: 'arithmetic',
  skill: 'addition',
  level: 4,

  // Domänspecifikt — bara domänmodulen läser detta
  payload: { a: 8, b: 47, operation: '+', result: 55 },

  // Standardiserat — adaptiva motorn läser detta
  difficulty: {
    conceptual_level: 4,
    cognitive_load: 2,
    tags: ['carry', '1d_2d']
  },

  // För visning — domänmodulen sätter detta
  display: {
    type: 'expression',
    text: '8 + 47'
  },

  // Rätt svar — domänmodulen definierar format
  answer: {
    type: 'number',
    correct: 55
  },

  metadata: {
    skillTag: 'add_1d_2d_carry',
    estimated_time: 15
  },

  generated_at: 1738000000000
}
```

**Regeln:** Ingenting utanför domänmodulen läser `payload`.
Adaptiva motorn läser `domain`, `skill`, `level`, `difficulty`.
Visningslagret renderar via domänens `Display`-komponent.
Profillagret sparar `domain`, `skill`, `level` och resultatdata.

### EvalResult

```js
{
  correct: false,
  studentAnswer: 45,
  isReasonable: true,
  absError: 10,
  relativeError: 0.18
}
```

### ErrorAnalysis

```js
{
  category: 'knowledge',              // 'none' | 'knowledge' | 'inattention'
  patterns: ['carry_error'],          // domänspecifika mönsternamn
  detail: 'Tiövergång hanterades inte i ental.'
}
```

`patterns` är en lista med strängar. Varje domän definierar sina egna.
Lärardashboarden kan aggregera dessa utan att veta vad de betyder —
den visar "3 elever har mönstret carry_error" baserat på frekvens.

### Adaptiva motorn

Lever i `src/engine/`. Domänagnostisk. Vet ingenting om vad bråk eller
addition är. Den vet:

- vilka skills som finns (via domänregistret)
- elevens historik per skill (nivå, success rate, felmönster)
- regler för svårighetsjustering (bucket-system, warmup, recovery)

Flödet:

```
1. selectNextSkillAndLevel(profile, options) → { domain, skill, level }
2. getDomain(domain).generate(skill, level) → problem
3. visa via getDomain(problem.domain).Display
4. eleven svarar
5. getDomain(problem.domain).evaluate(problem, answer) → evalResult
6. getDomain(problem.domain).analyzeError(problem, answer) → errorAnalysis
7. updateProfile(profile, problem, evalResult, errorAnalysis)
8. tillbaka till 1
```

### Komponentstruktur

```
src/components/
├── student/
│   ├── PracticeSession.jsx    # Orchestrator: flödet ovan. Max 300 rader.
│   ├── ProblemView.jsx        # Dispatchar till rätt domän-Display
│   ├── AnswerInput.jsx        # Keypad + textinput
│   ├── SessionHeader.jsx      # Namn, streak, avsluta
│   ├── FeedbackOverlay.jsx    # Rätt/fel
│   ├── BreakPrompt.jsx        # Pausförslag
│   ├── MilestoneOverlay.jsx   # Milstolpar, avancering
│   ├── StudentHome.jsx        # Startsida
│   └── StudentTicket.jsx      # Tickets
│
└── teacher/
    ├── Dashboard.jsx           # Shell: tabs/routing mellan sektioner
    └── sections/
        ├── ClassOverview.jsx
        ├── StudentDetail.jsx
        ├── Assignments.jsx
        ├── SkillBottlenecks.jsx
        ├── ClassManagement.jsx
        ├── Tickets.jsx
        └── ExportView.jsx
```

---

## Regler

### R1. En domän är en mapp

All domänspecifik logik (generering, visning, validering, felanalys) lever i
domänens mapp. Om du behöver en if-sats som kollar `if (domain === 'fractions')`
utanför domänmappen har du brutit arkitekturen. Använd domäninterfacet istället.

### R2. Inga jättefiler

Ingen fil ska vara längre än 400 rader. Om den växer förbi det, bryt ut.
Funktioner som gör en sak hör i egna filer.
Komponenter som renderar en sak hör i egna filer.

Nuvarande undantag som ska åtgärdas:
- `Dashboard.jsx` (~8000 rader) → bryts upp i sektioner
- `StudentSession.jsx` (~1700 rader) → bryts upp i PracticeSession + delkomponenter
- `difficultyAdapter.js` (~860 rader) → kärnan flyttas till engine/adaptiveEngine.js
- `storage.js` (~1200 rader) → acceptabel om den inte växer

### R3. Adaptiva motorn är domänagnostisk

Motorn i `src/engine/` importerar aldrig från `src/domains/arithmetic/` direkt.
Den använder `registry.js` för att hitta rätt domänmodul. Den läser `domain`,
`skill`, `level`, `difficulty` — aldrig `payload`.

### R4. Profilen lagrar fakta, inte tolkningar

Elevprofilen sparar: domain, skill, level, correct, studentAnswer,
errorCategory, patterns, timestamps, speedTimeSec.

Den sparar inte: "eleven har problem med bråk". Det beräknas vid visning
i lärardashboarden. Profilen är rådata, dashboarden är analys.

### R5. Bakåtkompatibilitet med elevdata

Elever har befintlig data i localStorage och Vercel KV. Ny kod måste hantera
profiler som skapades innan domänmodellen fanns. Det innebär:

- Om ett sparat problem saknar `domain`-fält, tolkas det som `arithmetic`.
- Om ett sparat problem saknar `skill`-fält, härleds det från `problemType`.
- Migrationsfunktioner lever i `src/engine/profileMigration.js`.
- Migrering sker vid profilladdning, inte vid sparning.

### R6. Testa beteende, inte implementation

Tester ska verifiera:
- "generate() returnerar ett problem med korrekta fält"
- "evaluate() returnerar correct:true för rätt svar"
- "analyzeError() returnerar 'carry_error' när eleven missar tiövergång"

Inte:
- "generateProblem anropar randomInt med (2, 8)"

Testerna ska överleva refaktorering inom en domän.

### R7. Svensk text, engelsk kod

Variabelnamn, funktioner, fält: engelska.
UI-text, labels, felmeddelanden till användaren: svenska.
Kommentarer: valfritt, men var konsekvent inom en fil.

### R8. Inga externa beroenden utan skäl

Appen använder React, React Router, Tailwind, Vite, @vercel/kv.
Lägg inte till npm-paket om standardbiblioteket räcker.
Speciellt: inga state management-bibliotek (Redux, Zustand). React state + context räcker.
Speciellt: inga CSS-bibliotek utöver Tailwind.
Speciellt: inga UI-komponentbibliotek (MUI, Chakra, etc).

### R9. Vercel-kompatibilitet

Appen deployas på Vercel free tier. API-routes i `api/` är serverless functions.
Inget kräver en persistent server. All state är i localStorage (klient) + KV (cloud).
Håll det så.

### R10. Eleven först

Vid designbeslut: prioritera elevupplevelsen. Snabb laddning, tydlig feedback,
inget krångel. Lärardashboarden kan vara komplex — den visas på en laptop.
Elevvyn visas på en surfplatta med långsam uppkoppling och en 12-åring som
tappar fokus efter 3 sekunder.

---

## Antipatterns — gör inte detta

**Parallella problemsystem.** Det ska finnas ETT sätt att generera problem:
via domänens `generate()`. Inte en generator för templates och en annan för
NCM-import och en tredje för tickets. Om extern data (NCM, läromedel) ska in,
görs det som templates/datakälla inom en domänmodul.

**Feature-flaggor i komponenter.** Inte `if (hasNCM) { ... } else if (hasFractions) { ... }`.
Domänregistret hanterar vilka domäner som finns. Komponenter dispatchar via registret.

**Monolitkomponenter.** Om en komponent har fler än 5 useState eller tar emot
fler än 6 props, bryt ut den.

**Dokumentation som ljuger.** Om docs/ beskriver en feature som inte finns i koden,
ta bort den ur docs/. Docs ska beskriva vad som finns, inte vad som planeras.
Planering hör hemma i TODO.md eller issues.

**Inline-styles och magic numbers.** Använd Tailwind-klasser. Definiera konstanter
med namn som förklarar vad de är (`WARMUP_PROBLEMS = 3`, inte `3`).

---

## Filöversikt

| Mapp | Ansvar |
|------|--------|
| `src/domains/` | Domänmoduler. En mapp per matematiskt område. |
| `src/domains/registry.js` | Registrerar domäner. Enda importpunkten för resten av appen. |
| `src/engine/` | Adaptiv motor, sessionshantering, profillogik. Domänagnostisk. |
| `src/components/student/` | Elevgränssnitt. Tunn orchestrator + delkomponenter. |
| `src/components/teacher/` | Lärardashboard. Shell + sektioner. |
| `src/lib/` | Gemensamma utilities: storage, telemetri, mathUtils. |
| `api/` | Vercel serverless functions. Thin wrappers kring KV. |
| `docs/` | Dokumentation som matchar verkligheten i koden. |

---

## Att verifiera efter varje ändring

1. `npm run test` — alla tester passerar
2. `npm run build` — bygget lyckas utan warnings
3. `npm run dev` — manuell test:
   - Logga in som elev → starta träning → svara rätt → svara fel → se feedback
   - Logga in som lärare → se elevlista → se enskild elev → exportera CSV
4. Befintlig elevdata laddas korrekt (inga profiler förloras)

---

## Nuvarande status

Appen har fungerande:
- Aritmetik (4 räknesätt, 65 templates, 12 nivåer)
- Adaptiv svårighetsjustering (per operation, bucket-system)
- Elevprofiler (localStorage + cloud sync till Vercel KV)
- Lärardashboard (klassöversikt, elevdetaljer, uppdrag, export)
- Ticket-system

Appen behöver refaktoreras till domänmodellen innan nya domäner läggs till.
